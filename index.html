<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Ready Resources - Tactical Display</title>
    <!-- Load Tailwind CSS for utility styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ========================================================================= */
        /* BASE TACTICAL AESTHETIC STYLING                                           */
        /* ========================================================================= */
        body {
            /* Use monospace font for a technical/tactical look */
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background-color: #1a202c; /* Deep Charcoal/Navy background */
            color: #e2e8f0; /* Off-White/Light Gray text for contrast */
            
            /* === TACTICAL FLAG BACKGROUND STYLING (Fixed Image Reference) === */
            background-image: url('tattered_flag.jpg-d2b2cd9e-033d-4afd-a872-9e3d7baa7682'); 
            background-size: cover; /* Cover the entire viewport */
            background-attachment: fixed; /* Keep background static on scroll */
            background-position: center center; /* Center the background image */
            background-repeat: no-repeat;
            min-height: 100vh; /* Ensure the body takes up the full viewport height */
        }

        .crisis-card {
            background-color: #b91c1c; /* Rescue Red for Crisis Line header */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Subtle shadow effect */
            border-bottom: 3px solid #f97316; /* Bright Orange accent line */
        }
        
        .data-display {
            background-color: rgba(30, 41, 59, 0.9); /* Slate Blue with transparency for tactical UI */
            border: 1px solid #475569; /* Slate border for structure */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px); /* Gentle blur effect on the background (if supported) */
            border-radius: 0.75rem; /* Consistent rounding */
        }

        .action-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px #0f766e; /* Shadow for 3D press effect (Teal) */
        }

        .action-button:active {
            box-shadow: 0 1px #0f766e; /* Reduce shadow depth when pressed */
            transform: translateY(3px); /* Move button down slightly */
        }

        /* Standard CSS animation for a loading spinner */
        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #10b981; /* Emerald Green spinner color */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styling for system log entries */
        .log-entry {
            border-left: 3px solid #475569; /* Vertical gray line for visual separation */
            padding-left: 0.5rem;
        }

        /* Ensure generated paragraph text looks readable within the content area */
        #resource-suggestions p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">
    
    <!-- ========================================================================= -->
    <!-- HEADER / CRISIS LINE                                                      -->
    <!-- ========================================================================= -->
    <header class="w-full max-w-4xl mb-6 crisis-card p-3 rounded-lg text-center flex flex-col items-center">
        <!-- TACTICAL ICON (Assumes image reference is correct from file system) -->
        <img src="uploaded:image_ad281c.png-d1e5c40e-743d-429f-845c-dfa8d0e43910" 
             alt="Tactical Icon" 
             class="w-12 h-12 mb-2"
             style="filter: invert(100%) hue-rotate(150deg) drop-shadow(0 0 5px rgba(16, 185, 129, 0.8));">
        
        <h1 class="text-2xl font-bold uppercase tracking-wider text-white">
            MISSION READY RESOURCES
        </h1>
        <p class="text-sm font-light text-gray-200">TACTICAL DISPLAY // GEOSPATIAL RESOURCE SCANNER</p>
    </header>

    <!-- ========================================================================= -->
    <!-- MAIN INTERFACE CARD (DATA DISPLAY)                                        -->
    <!-- ========================================================================= -->
    <main class="w-full max-w-4xl data-display p-6 sm:p-8 rounded-xl">
        
        <!-- COLLABORATION & AUTH INFO -->
        <div id="collab-info" class="text-center text-xs text-gray-500 mb-4 border-b border-gray-700 pb-3">
            <p>Auth Status: <span id="auth-status" class="font-mono text-yellow-400">CONNECTING...</span></p>
            <!-- User ID is mandatory for collaborative apps -->
            <p class="mt-1">User ID: <span id="user-id-display" class="font-mono text-teal-400 break-all">Awaiting Authentication</span></p>
            <p class="mt-1">Last Analysis Update: <span id="last-update-display" class="font-mono text-yellow-400">N/A</span></p>
        </div>

        <!-- DYNAMIC STATUS MESSAGE AREA -->
        <div id="status-message" class="hidden mb-4 p-3 rounded-lg text-sm transition duration-300" role="alert">
            <!-- Dynamic message content will go here -->
        </div>

        <!-- CONTROL PANEL -->
        <div class="mb-6">
            <button id="location-scan-button" 
                    class="action-button w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg uppercase tracking-widest flex justify-center items-center"
                    aria-live="polite"
                    disabled>
                AWAITING SYSTEM INITIALIZATION...
            </button>
            <div id="loading-indicator" class="hidden mt-4 flex items-center justify-center space-x-2">
                <div class="loading-animation"></div>
                <span class="text-sm text-gray-400">ACCESSING GEOLOCATION SENSORS... STAND BY.</span>
            </div>
        </div>

        <!-- CURRENT LOCATION DISPLAY SECTION -->
        <section id="location-info" class="hidden mb-6 p-4 border border-teal-500 rounded-lg bg-slate-800">
            <h2 class="text-xl font-semibold mb-2 text-teal-300">CURRENT POSITION DATA</h2>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div class="text-gray-400">Latitude:</div>
                <div id="lat-output" class="text-teal-400 font-mono">--</div>
                <div class="text-gray-400">Longitude:</div>
                <div id="lon-output" class="text-teal-400 font-mono">--</div>
            </div>
        </section>

        <!-- RESOURCE SUGGESTIONS (LLM OUTPUT) -->
        <section id="resource-section" class="hidden mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-emerald-400 border-b border-gray-600 pb-2 uppercase tracking-wide">
                ANALYSIS & RESOURCE SUGGESTIONS
            </h2>
            <div id="resource-suggestions" class="space-y-4">
                <p>Scan location to generate collaborative analysis...</p>
            </div>
            
            <!-- Citation Sources Display -->
            <div id="citation-sources" class="mt-6 pt-4 border-t border-gray-700">
                <h3 class="text-lg font-medium text-gray-400 mb-2">Grounding Sources:</h3>
                <ul id="sources-list" class="text-xs text-gray-500 space-y-1">
                    <!-- Sources will be injected here -->
                </ul>
            </div>
        </section>
        
        <!-- SYSTEM LOG WINDOW -->
        <section>
            <h2 class="text-xl font-semibold mt-6 mb-3 text-gray-400 border-b border-gray-700 pb-1">
                SYSTEM LOG
            </h2>
            <div id="system-log" class="h-48 overflow-y-auto p-3 bg-gray-900 border border-gray-700 rounded-lg text-xs space-y-1">
                <div class="log-entry text-gray-500">SYSTEM READY. AWAITING AUTHENTICATION.</div>
            </div>
        </section>

    </main>
    
    <script type="module">
        // =========================================================================
        // 1. FIREBASE IMPORTS AND GLOBAL CONFIGURATION
        // =========================================================================
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Core Application and API Constants ---
        const apiKey = "" // API key for Gemini is handled by runtime environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- Global Firebase Instances ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- Global variables MANDATED by the Canvas environment ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- UI Element References (Caching DOM lookups) ---
        const button = document.getElementById('location-scan-button');
        const loading = document.getElementById('loading-indicator');
        const locationInfo = document.getElementById('location-info');
        const resourceSection = document.getElementById('resource-section');
        const latOutput = document.getElementById('lat-output');
        const lonOutput = document.getElementById('lon-output');
        const suggestionsOutput = document.getElementById('resource-suggestions');
        const sourcesList = document.getElementById('sources-list');
        const lastUpdateDisplay = document.getElementById('last-update-display');
        const authStatusDisplay = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');


        // =========================================================================
        // 2. UTILITY FUNCTIONS (Logging, UI feedback, Markdown processing)
        // =========================================================================

        /**
         * Displays a formatted status message to the user in the dedicated UI area.
         * @param {string} text - The message content.
         * @param {boolean} [isError=false] - True if the message should be formatted as an error.
         */
        function showMessage(text, isError = false) {
            const statusDiv = document.getElementById('status-message');
            // Clear previous classes and set text
            statusDiv.textContent = text;
            statusDiv.classList.remove('hidden', 'bg-red-800', 'text-red-200', 'bg-green-800', 'text-green-200');
            
            // Apply appropriate styling based on message type
            if (isError) {
                statusDiv.classList.add('bg-red-800', 'text-red-200');
            } else {
                statusDiv.classList.add('bg-green-800', 'text-green-200');
            }
            logFeatureUse('Status_Message', { message: text });
        }

        /**
         * Resets the UI buttons and loading indicators to the default interactive state.
         */
        function resetUI() {
            // Button state depends on authentication status
            button.disabled = !isAuthReady; 
            button.textContent = isAuthReady ? 'EXECUTE LOCATION SCAN' : 'AWAITING SYSTEM INITIALIZATION...';
            loading.classList.add('hidden');
        }

        /**
         * Logs events to the in-app system log window for technical review.
         * @param {string} event - The type of event that occurred (e.g., 'Auth_Token_Login').
         * @param {object} [details={}] - Optional details, e.g., coordinates or error reason.
         */
        function logFeatureUse(event, details = {}) {
            const logElement = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const logEntry = document.createElement('div');
            
            let detailString = '';
            // Format coordinates if available
            if (details.coords) {
                detailString = ` (Lat: ${details.coords.latitude.toFixed(4)}, Lon: ${details.coords.longitude.toFixed(4)})`;
            } else if (details.reason) {
                detailString = ` (Reason: ${details.reason})`;
            }

            logEntry.className = 'log-entry text-gray-400';
            logEntry.innerHTML = `<span class="text-yellow-500">[${timestamp}]</span> <span class="text-teal-400">${event}</span>${detailString}`;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight; // Auto-scroll to the latest entry
        }

        /**
         * Converts simple Markdown formatting from the LLM output into HTML for display.
         * @param {string} markdown - The text output from the Gemini model.
         * @returns {string} HTML formatted string.
         */
        function markdownToHtml(markdown) {
            // 1. Convert **bolded text** to <strong>bolded text</strong>
            let html = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // 2. Convert double newlines to paragraph breaks (common LLM formatting)
            html = html.replace(/\n\n/g, '</p><p>');
            // 3. Convert single newlines to break tags (for list-like formatting preservation)
            html = html.replace(/\n/g, '<br>');
            // 4. Ensure the content is wrapped in a paragraph element
            if (!html.startsWith('<p>')) {
                html = '<p>' + html + '</p>';
            }
            return html;
        }
        
        /**
         * Updates the UI elements based on the analysis data received from Firestore.
         * This function is the primary display renderer.
         * @param {object | null} data - The analysis object loaded from Firestore.
         */
        function displayAnalysis(data) {
            if (!data || !data.analysisText) {
                // Handle case where the document is empty or non-existent
                suggestionsOutput.innerHTML = '<p>Scan location to generate collaborative analysis...</p>';
                resourceSection.classList.add('hidden');
                locationInfo.classList.add('hidden');
                lastUpdateDisplay.textContent = 'N/A';
                sourcesList.innerHTML = '';
                return;
            }

            // 1. Update time and location displays
            const date = new Date(data.timestamp);
            lastUpdateDisplay.textContent = date.toLocaleString();
            
            latOutput.textContent = data.latitude.toFixed(6);
            lonOutput.textContent = data.longitude.toFixed(6);
            locationInfo.classList.remove('hidden');

            // 2. Update LLM generated text
            suggestionsOutput.innerHTML = markdownToHtml(data.analysisText);

            // 3. Update sources/citations
            sourcesList.innerHTML = '';
            const sources = data.sources || [];
            if (sources.length > 0) {
                sources.forEach(source => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 underline">${source.title || source.uri}</a>`;
                    sourcesList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = "No external grounding sources provided by the LLM.";
                sourcesList.appendChild(listItem);
            }

            resourceSection.classList.remove('hidden');
        }


        // =========================================================================
        // 3. FIREBASE INTERACTION LOGIC
        // =========================================================================

        /**
         * Constructs the Firestore Document Reference path for the shared analysis data.
         * We use the 'public' space for collaboration across all users of this app.
         * Path: /artifacts/{appId}/public/data/analysis/master
         */
        function getAnalysisDocRef() {
            if (!db) return null;
            return doc(db, 'artifacts', appId, 'public', 'data', 'analysis', 'master');
        }

        /**
         * Saves the newly generated analysis data to the Firestore master document.
         * @param {object} data - The LLM analysis result and coordinates.
         */
        async function saveAnalysis(data) {
            if (!db) {
                logFeatureUse('Firestore_Error', { reason: 'DB not initialized for save' });
                return;
            }
            try {
                // Add metadata for auditing and display
                const analysisData = {
                    ...data,
                    timestamp: Date.now(),
                    generatedBy: userId,
                    // Note: analysisText and sources are already in 'data'
                };
                
                await setDoc(getAnalysisDocRef(), analysisData);
                logFeatureUse('Firestore_Save_Success', { coords: { latitude: data.latitude, longitude: data.longitude } });
            } catch (e) {
                // Handle potential Firestore write errors (e.g., permission denied)
                logFeatureUse('Firestore_Save_Failed', { reason: e.message });
                showMessage(`ERROR: Failed to save analysis to collaborative store: ${e.message}`, true);
            }
        }

        /**
         * Sets up the real-time listener to update the UI whenever the Firestore
         * master analysis document is modified by any collaborative user.
         */
        function listenForAnalysis() {
            // Guard clause: ensure prerequisites are met before setting up listener
            if (!db || !isAuthReady) return; 

            logFeatureUse('Firestore_Listener_Start');
            const docRef = getAnalysisDocRef();

            // onSnapshot provides real-time updates
            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    logFeatureUse('Firestore_Update_Received');
                    displayAnalysis(data); // Render the received data
                } else {
                    logFeatureUse('Firestore_Update_Empty');
                    displayAnalysis(null); // Clear display if document is deleted
                }
            }, (error) => {
                // Error handling for the listener itself
                logFeatureUse('Firestore_Listener_Error', { reason: error.message });
                showMessage(`ERROR: Real-time data sync failed: ${error.message}`, true);
            });
        }


        // =========================================================================
        // 4. GEMINI LLM INTERACTION LOGIC
        // =========================================================================

        /**
         * Fetches data from the LLM API, implementing exponential backoff for resilience.
         * @param {string} url - The API endpoint URL.
         * @param {object} options - Fetch options (method, headers, body).
         * @param {number} maxRetries - Maximum number of retries.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        // Rate limit exceeded: wait and retry
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error; // Re-throw only on final failure
                    // Log the retry but don't show it as a user error
                    logFeatureUse('API_Retry', { reason: `Attempt ${i + 1} failed.` });
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /**
         * Calls the Gemini API to get resource analysis for the provided coordinates.
         * It uses Google Search Grounding for real-world context.
         * @param {number} latitude - Current latitude.
         * @param {number} longitude - Current longitude.
         * @returns {Promise<object>} An object containing analysis text, sources, and coordinates.
         */
        async function getResourceSuggestions(latitude, longitude) {
            logFeatureUse('LLM_QUERY_INIT', { coords: { latitude, longitude } });

            const userQuery = `I am currently located at Latitude ${latitude.toFixed(6)} and Longitude ${longitude.toFixed(6)}. Based on this location, provide a concise tactical analysis of immediately accessible and potentially critical resources (like water sources, shelter, communication points, or useful terrain features). Structure your response with distinct, bolded headers for each suggested resource and provide a brief description for each.`;
            
            const systemPrompt = "You are a highly efficient, tactical mission analyst for a disaster recovery team. Your goal is to provide fast, actionable, and grounded resource intelligence based on a provided geospatial location. Output ONLY the analysis content, formatted in Markdown. Use Google Search grounding to find real-world context for the coordinates.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Enable real-time web search
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(GEMINI_API_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    logFeatureUse('LLM_QUERY_SUCCESS');

                    // 1. Extract grounding sources (citations)
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    return { analysisText: text, sources, latitude, longitude };

                } else {
                    const errorMessage = result.error?.message || "LLM did not return usable content or had a malformed response.";
                    logFeatureUse('LLM_QUERY_FAIL', { reason: errorMessage });
                    throw new Error(errorMessage);
                }

            } catch (error) {
                logFeatureUse('LLM_FETCH_ERROR', { reason: error.message });
                throw new Error("Failed to contact intelligence servers: " + error.message);
            }
        }


        // =========================================================================
        // 5. GEOLOCATION AND MAIN CLICK HANDLER
        // =========================================================================

        function handleScanClick() {
            // Pre-check authentication status
            if (!isAuthReady) {
                 showMessage("SYSTEM NOT READY: Authentication required. Standby.", true);
                 return;
            }

            logFeatureUse('EXECUTE_SCAN_CLICKED');
            
            // Set UI state to scanning/loading
            button.disabled = true;
            button.textContent = 'SCANNING...';
            loading.classList.remove('hidden');
            document.getElementById('status-message').classList.add('hidden');
            
            // Check for browser geolocation support
            if (!navigator.geolocation) {
                showMessage("ERROR: GEOLOCATION IS NOT SUPPORTED BY THIS BROWSER.", true);
                logFeatureUse('Resource_Search_Failed', { reason: 'No_Geolocation' });
                resetUI();
                return;
            }

            // Request user's location via browser API
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    
                    logFeatureUse('COORDS_RETRIEVED', { coords: { latitude, longitude } });
                    
                    button.textContent = 'ANALYZING LOCATION DATA...';

                    try {
                        // 1. Get analysis from Gemini
                        const analysisData = await getResourceSuggestions(latitude, longitude);
                        
                        // 2. Save analysis to collaborative Firestore document
                        await saveAnalysis(analysisData);
                        
                        // Note: The UI display (displayAnalysis) is handled by the onSnapshot listener after save
                        showMessage("SCAN COMPLETE. ANALYSIS GENERATED AND SHARED.", false);
                        logFeatureUse('MISSION_COMPLETE');

                    } catch (error) {
                        showMessage(`CRITICAL ERROR: ${error.message}`, true);
                        logFeatureUse('RESOURCE_ANALYSIS_FAILED', { reason: error.message });
                    } finally {
                        // Reset UI regardless of success or failure
                        resetUI();
                    }
                },
                (error) => {
                    // Detailed Geolocation Error Handling
                    let errorMessage = "ERROR: UNABLE TO RETRIEVE COORDS.";
                    let failReason = 'Unknown';
                    
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "ERROR: GEOLOCATION DENIED. PLEASE ENABLE DEVICE LOCATION SERVICES.";
                        failReason = 'Permission_Denied';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMessage = "ERROR: LOCATION DATA UNAVAILABLE. TRY MOVING TO AN OPEN AREA.";
                        failReason = 'Position_Unavailable';
                    } else if (error.code === error.TIMEOUT) {
                        errorMessage = "ERROR: LOCATION REQUEST TIMEOUT. CHECK CONNECTION STRENGTH.";
                        failReason = 'Timeout';
                    }
                    
                    showMessage(errorMessage, true);
                    resetUI();
                    logFeatureUse('Resource_Search_Failed', { reason: failReason });
                },
                // Geolocation options
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        // =========================================================================
        // 6. INITIALIZATION AND LIFECYCLE MANAGEMENT
        // =========================================================================

        /**
         * Performs all Firebase initialization and authentication logic.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("FATAL ERROR: Firebase configuration is missing. Cannot initialize database.", true);
                logFeatureUse('Firebase_Init_Failed', { reason: 'No_Config' });
                return;
            }

            try {
                // IMPORTANT: Set debug level for better console logging
                setLogLevel('debug');
                
                // Initialize Firebase app and services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                logFeatureUse('Firebase_Services_Initialized');

                // --- Sign-In Logic (using initial token or falling back to anonymous) ---
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    logFeatureUse('Auth_Token_Login_Attempt');
                } else {
                    await signInAnonymously(auth);
                    logFeatureUse('Auth_Anonymous_Login_Attempt');
                }

                // --- Authentication State Change Listener ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User successfully signed in
                        userId = user.uid;
                        isAuthReady = true;
                        authStatusDisplay.textContent = 'CONNECTED';
                        authStatusDisplay.classList.replace('text-yellow-400', 'text-green-400');
                        userIdDisplay.textContent = userId;
                        logFeatureUse('User_Authenticated_Success');
                        
                        // Enable main functionality and start real-time sync
                        resetUI(); 
                        listenForAnalysis();
                    } else {
                        // User signed out (should not happen in Canvas, but good practice)
                        userId = null;
                        isAuthReady = false;
                        authStatusDisplay.textContent = 'DISCONNECTED';
                        authStatusDisplay.classList.replace('text-green-400', 'text-yellow-400');
                        userIdDisplay.textContent = 'Not Signed In';
                        resetUI();
                    }
                });

            } catch (e) {
                // Catch all initialization and sign-in errors
                showMessage(`FATAL ERROR: System Initialization Failed. ${e.message}`, true);
                logFeatureUse('Firebase_Init_Failed', { reason: e.message });
                authStatusDisplay.textContent = 'FAILED';
                authStatusDisplay.classList.replace('text-yellow-400', 'text-red-400');
                userIdDisplay.textContent = 'System Halted';
            }
        }


        // --- APPLICATION ENTRY POINT ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            button.addEventListener('click', handleScanClick);
            logFeatureUse('DOM_Content_Loaded');
        });
    </script>
</body>
</html>
