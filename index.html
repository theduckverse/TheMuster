<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soldiers of Valor - Veteran Resource Command Console</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --hud-green: #31ff7a;
            --hud-green-dark: #1f3324;
            --hud-bg: #09100d;
            --hud-card: #0e1612;
        }

        body {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background-color: #020617;
            color: #e5e7eb;
        }

        .hud-glow { text-shadow: 0 0 8px rgba(49,255,122,0.5); }
        .hud-border { border: 1px solid rgba(49,255,122,0.25); }
        .hud-border-strong { border: 1px solid rgba(49,255,122,0.5); }

        .nav-shadow { box-shadow: 0 4px 24px rgba(0,0,0,0.6); }
        .hero-bg {
            background: linear-gradient(
                to bottom,
                rgba(9,16,13,0.95),
                rgba(4,7,5,0.99)
            );
            border-bottom: 1px solid rgba(49,255,122,0.25);
        }

        /* Cards */
        .panel {
            background: var(--hud-card);
            border-radius: 0.75rem;
            border: 1px solid rgba(148,163,184,0.25);
            padding: 1.2rem;
            box-shadow: 0 0 16px rgba(0,0,0,0.4);
        }

        .accent-green { color: #22c55e; }
        .accent-orange { color: #f97316; }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(to bottom, var(--hud-green), #0f3d24);
            color: #020617;
            padding: 0.7rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid rgba(49,255,122,0.8);
            transition: 0.15s ease;
        }
        .btn-primary:hover:not(:disabled) {
            filter: brightness(1.15);
            box-shadow: 0 0 18px rgba(49,255,122,0.7);
        }
        .btn-primary:disabled {
            background: #374151;
            color: #9ca3af;
            border-color: rgba(75,85,99,0.8);
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #0c1410;
            border: 1px solid rgba(148,163,184,0.4);
            padding: 0.65rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            color: #e5e7eb;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            transition: 0.15s ease;
        }
        .btn-secondary:hover:not(:disabled) {
            background: rgba(49,255,122,0.15);
            border-color: var(--hud-green);
            box-shadow: 0 0 12px rgba(49,255,122,0.5);
        }
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Tab Bar */
        .tab-button {
            flex: 1;
            padding: 0.75rem;
            background: #0b1310;
            border-bottom: 3px solid rgba(49,255,122,0.25);
            font-weight: 700;
            letter-spacing: 0.1em;
            transition: 0.15s ease;
            font-size: 0.74rem;
            text-transform: uppercase;
        }
        .tab-button:hover {
            background: rgba(49,255,122,0.1);
        }
        .tab-active {
            background: rgba(49,255,122,0.18);
            border-color: var(--hud-green);
            box-shadow: 0 0 12px rgba(49,255,122,0.4);
            color: var(--hud-green);
        }
        .tab-inactive {
            opacity: 0.8;
            color: #9ca3af;
        }

        /* Inputs / Textareas */
        input[type="text"],
        textarea {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
            border: 1px solid rgba(34, 197, 94, 0.7);
            color: #bbf7d0;
            padding: 0.7rem 0.8rem;
            border-radius: 0.65rem;
            font-size: 0.85rem;
            outline: none;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 1);
            transition:
                border-color 0.16s ease,
                box-shadow 0.16s ease,
                background 0.16s ease;
        }
        input[type="text"]::placeholder,
        textarea::placeholder {
            color: rgba(148, 163, 184, 0.7);
        }
        input[type="text"]:focus,
        textarea:focus {
            border-color: #f97316;
            box-shadow:
                0 0 0 1px rgba(15, 23, 42, 1),
                0 0 18px rgba(249, 115, 22, 0.7);
            background: radial-gradient(circle at top left, rgba(22, 163, 74, 0.22), rgba(15, 23, 42, 0.98));
        }

        /* Loading ring */
        .loading-ring {
            border: 4px solid rgba(30, 64, 175, 0.6);
            border-top: 4px solid #22c55e;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.7);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        /* Toast / message box */
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-3px);
        }

        /* Resource section tweaks */
        #resource-section h2 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }
        #resource-section h2::before {
            content: "â—‰";
            font-size: 0.85rem;
            color: #22c55e;
            text-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
        }
        #resource-list li {
            position: relative;
            overflow: hidden;
        }
        #resource-list li::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(
                120deg,
                transparent 0%,
                rgba(34, 197, 94, 0.06) 40%,
                rgba(59, 130, 246, 0.05) 60%,
                transparent 100%
            );
            opacity: 0;
            transition: opacity 0.18s ease-in-out;
        }
        #resource-list li:hover::before {
            opacity: 1;
        }
        #resource-list .accent-orange {
            text-shadow: 0 0 10px rgba(249, 115, 22, 0.9);
        }
        #resource-list a {
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.7rem;
        }
        #resource-list a:hover {
            text-shadow: 0 0 9px rgba(34, 197, 94, 0.9);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- CRISIS HEADER -->
    <header class="p-4 bg-red-700/30 text-white text-center shadow-md border-b border-red-500">
        <h1 class="text-3xl font-extrabold tracking-widest hud-glow">
            SOLDIERS OF VALOR
        </h1>
        <p class="text-sm opacity-80">OPERATIONAL STATUS: HIGH</p>

        <a href="tel:988"
           class="mt-3 inline-flex items-center space-x-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-md font-bold transition shadow-xl">
           <span>ðŸš¨ CRISIS LINE: CALL 988</span>
        </a>
    </header>

    <!-- AUTH STATUS -->
    <div id="auth-status" class="bg-green-900/40 text-green-400 p-2 text-xs text-center border-b border-green-700">
        :: INITIALIZING SECURE LINK ::
    </div>

    <!-- NEW STICKY NAVBAR -->
    <nav class="sticky top-0 z-50 bg-[#0f1a14] nav-shadow border-b border-green-900">
        <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3">

            <!-- LOGO -->
            <span class="text-lg font-bold text-[var(--hud-green)] hud-glow tracking-widest">
                COMMAND CONSOLE
            </span>

            <!-- SEARCH -->
            <input id="sov-search"
                   type="text"
                   placeholder="Search benefits, jobs, resources..."
                   onkeydown="if(event.key==='Enter'){performSearch()}"
                   class="hidden md:block px-3 py-2 bg-[#0c140f] text-gray-300 hud-border rounded focus:outline-none w-72" />

            <!-- NAV LINKS -->
            <div class="hidden md:flex space-x-6 text-sm uppercase tracking-widest">
                <button class="hover:text-[var(--hud-green)]" onclick="window.switchTab('goals')">Mission Planner</button>
                <button class="hover:text-[var(--hud-green)]" onclick="window.switchTab('map')">Local Resources</button>
                <button class="hover:text-[var(--hud-green)]" onclick="window.switchTab('employment')">Employment</button>
                <button class="hover:text-[var(--hud-green)]" onclick="window.switchTab('benefits')">Benefits</button>
                <button class="hover:text-[var(--hud-green)]" onclick="window.switchTab('muster')">The Muster</button>
            </div>
        </div>
    </nav>

    <!-- HERO SECTION -->
    <section class="hero-bg py-16 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold text-[var(--hud-green)] hud-glow tracking-wide">
            YOUR TACTICAL ADVANTAGE IN CIVILIAN LIFE
        </h1>
        <p class="mt-6 text-gray-300 text-lg max-w-2xl mx-auto">
            Real-time resources, mission-ready planning, employment translation, and community support â€”
            all inside a unified HUD-style veteran platform.
        </p>

        <div class="mt-8 flex justify-center space-x-4">
            <button onclick="window.switchTab('goals')" class="btn-primary">
                Launch Mission Planner
            </button>
            <button onclick="window.switchTab('map')" class="btn-secondary">
                Scan Local Resources
            </button>
        </div>
    </section>

    <!-- TAB BAR -->
    <div class="flex bg-[#0b1310] border-b border-green-800">
        <button id="tab-map" class="tab-button tab-inactive" onclick="window.switchTab('map')">RESOURCE LOCATOR</button>
        <button id="tab-benefits" class="tab-button tab-inactive" onclick="window.switchTab('benefits')">BENEFITS PROTOCOL</button>
        <button id="tab-goals" class="tab-button tab-inactive" onclick="window.switchTab('goals')">MISSION PLANNER</button>
        <button id="tab-muster" class="tab-button tab-inactive" onclick="window.switchTab('muster')">THE MUSTER</button>
        <button id="tab-employment" class="tab-button tab-active" onclick="window.switchTab('employment')">EMPLOYMENT HUB</button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-6xl mx-auto w-full px-4 py-6 space-y-6">

        <!-- TAB 1: RESOURCE MAP CONTENT -->
        <section id="content-map" class="hidden space-y-4">
            <button id="view-history-btn" class="btn-secondary w-full" disabled>
                ACCESS LOG HISTORY (LOADING...)
            </button>

            <div id="location-card" class="panel space-y-3">
                <h2 class="text-xl font-semibold accent-green flex items-center space-x-2">
                    <span>ðŸŽ¯</span>
                    <span>TARGET: Local Resources</span>
                </h2>
                <div id="location-info" class="text-gray-300">
                    <p>Execute location scan to identify nearby services.</p>
                    <p id="current-location" class="font-medium mt-2 hidden">
                        COORDS: <span id="lat-long" class="accent-orange"></span>
                    </p>
                </div>
                <button id="find-location-btn" class="btn-primary w-full" disabled>
                    EXECUTE LOCATION SCAN
                </button>
                <div id="loading-indicator" class="hidden flex justify-center py-2">
                    <div class="loading-ring"></div>
                </div>
            </div>

            <div id="resource-section" class="resource-list panel space-y-3 hidden">
                <h2 class="text-xl font-semibold accent-green">LOCAL RESOURCE SCAN: LIVE DATA</h2>
                <p class="text-sm text-gray-400">STATUS: synced with secure Firebase node.</p>
                <ul id="resource-list" class="space-y-4"></ul>
            </div>
        </section>

        <!-- TAB 2: BENEFITS NAVIGATOR CONTENT -->
        <section id="content-benefits" class="hidden space-y-6">
            <h2 class="text-2xl font-bold accent-green border-b border-gray-600 pb-2 font-mono">
                BENEFITS PROTOCOL: CLAIMS
            </h2>
            <p class="text-gray-400 text-sm">
                Filing a disability claim is mission-critical. The steps provided are general knowledge and in no way
                constitute legal advice. Every outcome is different and we share our knowledge to help get the best
                outcome for our veteran brothers and sisters. Feel free to email us if you have anything to add to this
                sequence.
            </p>

            <!-- Step 1 -->
            <div class="panel space-y-2 border-l-4 border-green-500">
                <div class="flex items-center space-x-2">
                    <span class="text-xl font-extrabold accent-orange">01</span>
                    <h3 class="font-bold text-lg accent-green">DATA ACQUISITION</h3>
                </div>
                <ul class="list-disc ml-5 text-sm text-gray-400 space-y-1">
                    <li>***The best practice before filing a claim is to seek outside medical attention.*** If it is a PTSD claim, seek mental health providers ahead of time, if it is an injury, seek help from a specialist before filing, this step alone is crucial in establishing your nexus, which is discussed later in these steps.</li>
                    <li><strong>Service Connection:</strong> Acquire DD-214 and Service Treatment Records (STRs)... (content unchanged)</li>
                    <li><strong>Medical Evidence:</strong> Secure your Service Treatment Records (STRs)...</li>
                    <li><strong>Nexus:</strong> As stated above, this step is crucial in linking current status to service actions... Be cautious of for-profit claim companies.</li>
                </ul>
            </div>

            <!-- Step 2 -->
            <div class="panel space-y-2 border-l-4 border-green-500">
                <div class="flex items-center space-x-2">
                    <span class="text-xl font-extrabold accent-orange">02</span>
                    <h3 class="font-bold text-lg accent-green">SUBMISSION ROUTE</h3>
                </div>
                <ul class="list-disc ml-5 text-sm text-gray-400 space-y-1">
                    <li><strong>Fast Track:</strong> Utilize the VA digital portal
                        <a href="https://www.va.gov" target="_blank" class="accent-orange hover:text-red-500">VA.gov</a>.
                    </li>
                    <li><strong>Priority Channel:</strong> Contact a Veterans Service Officer (VSO) for free, expert support.</li>
                    <li><strong>Effective Date Lock:</strong> File an Intent to File immediately:
                        <a href="https://www.va.gov/supporting-forms-for-claims/intent-to-file-form-21-0966/introduction"
                           target="_blank"
                           class="accent-orange hover:text-red-500">INTENT TO FILE</a>.
                    </li>
                </ul>
            </div>

            <!-- Step 3 -->
            <div class="panel space-y-2 border-l-4 border-green-500">
                <div class="flex items-center space-x-2">
                    <span class="text-xl font-extrabold accent-orange">03</span>
                    <h3 class="font-bold text-lg accent-green">C&P EVALUATION</h3>
                </div>
                <ul class="list-disc ml-5 text-sm text-gray-400 space-y-1">
                    <li><strong>Compliance:</strong> Attend all mandated Compensation &amp; Pension (C&amp;P) exams.</li>
                    <li><strong>Reporting:</strong> Describe your condition's current impact on daily function. Be specific.</li>
                </ul>
            </div>

            <!-- Step 4 -->
            <div class="panel space-y-2 border-l-4 border-green-500">
                <div class="flex items-center space-x-2">
                    <span class="text-xl font-extrabold accent-orange">04</span>
                    <h3 class="font-bold text-lg accent-green">RESOLUTION &amp; APPEAL</h3>
                </div>
                <ul class="list-disc ml-5 text-sm text-gray-400 space-y-1">
                    <li><strong>Review:</strong> Confirm rating accuracy upon decision.</li>
                    <li><strong>Recourse:</strong> If denied, consult a VSO immediately to initiate Supplemental, HLR, or Board Appeal.</li>
                </ul>
            </div>

            <p class="text-xs text-gray-500 pt-2">
                :: DISCLOSURE: THIS IS A GUIDANCE TOOL, NOT OFFICIAL VA DIRECTIVE. CONSULT VSO. ::
            </p>
        </section>

        <!-- TAB 3: MISSION GOAL TRACKER CONTENT -->
        <section id="content-goals" class="hidden space-y-4">
            <h2 class="text-2xl font-bold accent-green border-b border-gray-600 pb-2 font-mono">
                MISSION PLANNER
            </h2>
            <p class="text-gray-400 text-sm">
                Define your objective and track your steps. Progress is logged in your secure private cloud.
            </p>

            <div class="panel space-y-3">
                <h3 class="text-xl font-semibold accent-green border-b border-gray-600 pb-2">
                    INPUT NEW OBJECTIVE
                </h3>
                <input type="text" id="goal-title"
                       placeholder="E.g., Complete my degree, Find a career in tech, Improve fitness"
                       maxlength="80">
                <div id="milestone-inputs" class="space-y-2">
                    <input type="text" data-milestone="1" placeholder="Step 1: Define specific task" class="text-sm">
                    <input type="text" data-milestone="2" placeholder="Step 2: Define specific task" class="text-sm">
                    <input type="text" data-milestone="3" placeholder="Step 3: Define specific task" class="text-sm">
                </div>
                <button id="add-goal-btn" class="btn-primary w-full" disabled>
                    SAVE NEW MISSION
                </button>
            </div>

            <div class="space-y-3">
                <h3 class="text-xl font-semibold accent-green border-b border-gray-600 pb-2">
                    ACTIVE MISSIONS
                </h3>
                <div id="goal-list-container" class="space-y-4">
                    <p id="goals-loading" class="text-center text-gray-500 py-4">
                        Awaiting missions... Initializing link.
                    </p>
                </div>
            </div>
        </section>

        <!-- TAB 4: COMMUNITY MUSTER -->
        <section id="content-muster" class="hidden space-y-4">
            <h2 class="text-2xl font-bold accent-green border-b border-gray-600 pb-2 font-mono">
                THE MUSTER (SECURE CHANNEL)
            </h2>
            <p class="text-gray-400 text-sm">
                Post tactical status updates and community announcements.
            </p>

            <div class="panel space-y-3">
                <textarea id="huddle-post-input"
                          placeholder="Transmit message (Max 200 chars)"
                          rows="2"
                          maxlength="200"></textarea>
                <button id="post-message-btn" class="btn-primary w-full" disabled>
                    TRANSMIT MESSAGE
                </button>
            </div>

            <div id="community-feed" class="space-y-3 max-h-[60vh] overflow-y-auto">
                <p id="muster-loading" class="text-center text-gray-500 py-4">
                    :: CHANNEL STATUS: AWAITING LINK ::
                </p>
            </div>
        </section>

        <!-- TAB 5: EMPLOYMENT HUB -->
        <section id="content-employment" class="space-y-6">
            <h2 class="text-2xl font-bold accent-green border-b border-gray-600 pb-2 font-mono">
                EMPLOYMENT HUB: SKILLS TRANSLATOR
            </h2>
            <p class="text-gray-400 text-sm">
                Translate MOS/Rate/Duty into Civilian Credentials for maximum resume impact.
            </p>

            <div class="panel space-y-4">
                <h3 class="text-xl font-semibold accent-green">
                    MILITARY TO CIVILIAN TRANSLATION
                </h3>

                <input type="text" id="military-term-input"
                       placeholder="INPUT MOS, RATE, OR DUTY (e.g., 68W, EO, PLATOON LEADER)">

                <button id="translate-btn"
                        class="bg-orange-500 text-gray-900 py-3 rounded-md font-bold shadow-md transition-colors duration-200 hover:bg-orange-600 w-full">
                    EXECUTE TRANSLATION
                </button>

                <div id="translation-result" class="hidden border-t border-gray-600 pt-4 space-y-3">
                    <div id="job-title-output" class="text-lg font-bold text-green-400"></div>
                    <div id="skills-output" class="text-gray-300 space-y-1"></div>
                    <p class="text-xs text-gray-500 mt-2">
                        :: CREDENTIALS READY FOR RESUME INTEGRATION ::
                    </p>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="text-xl font-semibold accent-green border-b border-gray-600 pb-2">
                    TOP EMPLOYMENT ASSETS
                </h3>
                <ul class="space-y-3 text-sm text-gray-300">
                    <li class="p-3 bg-gray-800 rounded-md border-l-4 border-green-500">
                        <a href="https://www.linkedin.com/in/vets"
                           target="_blank"
                           class="font-bold text-green-400 hover:text-green-300">
                            LinkedIn for Veterans:
                        </a> Priority access to job seekers.
                    </li>
                    <li class="p-3 bg-gray-800 rounded-md border-l-4 border-green-500">
                        <a href="https://www.dol.gov/agencies/vets"
                           target="_blank"
                           class="font-bold text-green-400 hover:text-green-300">
                            Dept. of Labor VETS:
                        </a> Career training and workshops.
                    </li>
                </ul>
            </div>
        </section>

        <!-- MESSAGE / ALERT CONTAINER -->
        <div id="message-box" class="message-box p-4 hidden">
            <div id="message-content"
                 class="bg-red-700 text-white p-3 rounded-md shadow-xl text-sm font-medium border border-red-500"></div>
        </div>

        <!-- HISTORY MODAL -->
        <div id="history-modal" class="modal-overlay hidden">
            <div class="panel rounded-xl p-6 w-11/12 max-w-md max-h-[80vh] flex flex-col">
                <h3 class="text-2xl font-bold accent-green mb-4 border-b border-gray-600 pb-2">
                    ACCESS LOG: HISTORY (SECURE)
                </h3>
                <div id="history-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                    <p class="text-center text-gray-500 mt-4">:: LOADING LOGS ::</p>
                </div>
                <button id="close-history-btn" class="mt-4 btn-secondary">
                    CLOSE LOG
                </button>
            </div>
        </div>

    </main>

    <!-- FIREBASE + APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            update,
            onValue,
            remove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        const appId = 'veteran-resource-app';

        const firebaseConfig = {
            apiKey: "AIzaSyDxWnKmEvg-JFxXopujpYiDQ98bee5n46E",
            authDomain: "vetchat-prod.firebaseapp.com",
            projectId: "vetchat-prod",
            storageBucket: "vetchat-prod.appspot.com",
            messagingSenderId: "511042065899",
            appId: "1:511042065899:web:da21e4652341903e5ef5ae",
            measurementId: "G-18R9J9CF33S",
            databaseURL: "https://vetchat-prod-default-rtdb.firebaseio.com"
        };

        const initialAuthToken = null;

        const authStatusEl        = document.getElementById('auth-status');
        const findLocationBtn     = document.getElementById('find-location-btn');
        const addGoalBtn          = document.getElementById('add-goal-btn');
        const postMessageBtn      = document.getElementById('post-message-btn');
        const viewHistoryBtn      = document.getElementById('view-history-btn');
        const historyListEl       = document.getElementById('history-list');
        const goalListContainerEl = document.getElementById('goal-list-container');
        const goalTitleInput      = document.getElementById('goal-title');
        const milestoneInputs     = document.getElementById('milestone-inputs').querySelectorAll('input');
        const goalsLoadingEl      = document.getElementById('goals-loading');
        const huddlePostInput     = document.getElementById('huddle-post-input');
        const communityFeedEl     = document.getElementById('community-feed');
        const musterLoadingEl     = document.getElementById('muster-loading');

        function showMessage(text, isError = false) {
            const msgBox = document.getElementById('message-box');
            const msgContent = document.getElementById('message-content');

            if (isError) {
                msgContent.className = 'bg-red-700 text-white p-3 rounded-md shadow-xl text-sm font-medium border border-red-500';
            } else {
                msgContent.className = 'bg-green-700 text-white p-3 rounded-md shadow-xl text-sm font-medium border border-green-500';
            }

            msgContent.textContent = text;
            msgBox.classList.add('show');
            msgBox.classList.remove('hidden');

            setTimeout(() => {
                msgBox.classList.remove('show');
                setTimeout(() => msgBox.classList.add('hidden'), 300);
            }, 3000);
        }

        const getPrivateRef = (path) => {
            if (!db || !userId) return null;
            return ref(db, `artifacts/${appId}/users/${userId}/${path}`);
        };

        function getPublicRef(path) {
            return ref(db, `artifacts/${appId}/_public/data/${path}`);
        }

        function renderResourceList(items) {
            const section = document.getElementById("resource-section");
            const listEl = document.getElementById("resource-list");

            listEl.innerHTML = "";

            if (!items || items.length === 0) {
                section.classList.add("hidden");
                return;
            }

            section.classList.remove("hidden");

            items.forEach(item => {
                const html = `
                    <li class="border-b border-gray-600 pb-3">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl accent-orange">âš‘</span>
                            <div class="flex-grow">
                                <p class="font-bold text-lg">${item.name || 'Resource'}</p>
                                <p class="text-sm text-gray-400">${item.facility || ''}</p>
                            </div>
                        </div>
                        ${item.link ? `<a href="${item.link}" target="_blank" class="accent-green font-semibold text-sm hover:text-green-300">ROUTE</a>` : ''}
                        <p class="text-xs text-gray-500 mt-1">${item.description || ''}</p>
                    </li>
                `;
                listEl.insertAdjacentHTML("beforeend", html);
            });
        }

        function startResourceListener() {
            const resourcesRef = getPublicRef("resource_locations");
            onValue(resourcesRef, (snapshot) => {
                const data = snapshot.val() || {};
                const items = Object.keys(data).map(id => ({
                    id,
                    ...data[id]
                }));
                renderResourceList(items);
            });
        }

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db   = getDatabase(app);

            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Authentication Error:", error);
                    showMessage("AUTH ERROR: Could not establish secure link.", true);
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    authStatusEl.innerHTML = `:: SECURE LINK ESTABLISHED - UNIT ID: <span class="accent-orange">${userId.substring(0, 8)}...</span> ::`;

                    findLocationBtn.disabled = false;
                    addGoalBtn.disabled      = false;
                    postMessageBtn.disabled  = false;
                    viewHistoryBtn.disabled  = false;

                    startHistoryListener();
                    startGoalListener();
                    startMusterListener();
                    startResourceListener();
                } else {
                    userId = null;
                    isAuthReady = false;
                    authStatusEl.innerHTML = ":: LINK FAILURE. Attempting reconnection. ::";

                    findLocationBtn.disabled = true;
                    addGoalBtn.disabled      = true;
                    postMessageBtn.disabled  = true;
                    viewHistoryBtn.disabled  = true;
                }
            });

            authenticate();
        } catch (error) {
            console.error("Firebase Init Error:", error);
            authStatusEl.innerHTML = ":: ERROR: CONFIG FAILURE. Firebase services unavailable. ::";
        }

        async function logSearch(lat, lon) {
            if (!isAuthReady || !userId) return;
            const historyRef = getPrivateRef('search_history');
            if (!historyRef) return;

            const entryRef = push(historyRef);
            try {
                await set(entryRef, {
                    timestamp: Date.now(),
                    latitude: lat,
                    longitude: lon,
                    mock_resources_found: 4,
                    location_description: "Local Area Scan"
                });
            } catch (e) {
                console.error("Error logging search:", e);
                showMessage("Database error: Could not log search history.", true);
            }
        }

        function startHistoryListener() {
            const historyRef = getPrivateRef('search_history');
            if (!historyRef) return;

            onValue(historyRef, (snapshot) => {
                const data = snapshot.val() || {};
                const items = Object.keys(data).map(id => ({ id, ...data[id] }));
                items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                updateHistoryUI(items);
            }, (error) => {
                console.error("History Listener Error:", error);
                historyListEl.innerHTML = '<p class="text-center text-red-400 mt-4">:: HISTORY LOG ERROR ::</p>';
            });
        }

        function updateHistoryUI(historyItems) {
            viewHistoryBtn.textContent = `ACCESS LOG HISTORY (${historyItems.length} RECORDS)`;
            historyListEl.innerHTML = '';

            if (historyItems.length === 0) {
                historyListEl.innerHTML = '<p class="text-center text-gray-500 mt-4">:: NO LOGS FOUND IN DATABASE ::</p>';
                return;
            }

            historyItems.forEach((item, index) => {
                const date = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'Pending Sync';
                const lat  = typeof item.latitude  === 'number' ? item.latitude.toFixed(4)  : 'N/A';
                const lon  = typeof item.longitude === 'number' ? item.longitude.toFixed(4) : 'N/A';

                const itemHtml = `
                    <div class="bg-gray-700/50 p-3 rounded-md border border-gray-600">
                        <p class="accent-green font-semibold">LOG ENTRY #${historyItems.length - index}</p>
                        <p class="text-sm text-gray-400">TIMESTAMP: ${date}</p>
                        <p class="text-sm text-gray-400 mt-1">
                            <span class="font-medium">COORDS:</span> ${lat}, ${lon}
                        </p>
                        <p class="text-xs accent-orange mt-1">
                            Found ${item.mock_resources_found || 0} assets in the ${item.location_description || 'Area'} area.
                        </p>
                    </div>
                `;
                historyListEl.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        addGoalBtn.addEventListener('click', async () => {
            if (!isAuthReady || !userId) return showMessage("Authentication required to save mission.", true);

            const title = goalTitleInput.value.trim();
            const steps = Array.from(milestoneInputs)
                .map(input => input.value.trim())
                .filter(text => text.length > 0)
                .map(text => ({ text, completed: false }));

            if (title.length < 5) return showMessage("Input requires more detail for objective title.", true);
            if (steps.length === 0) return showMessage("Input requires at least one defined step.", true);

            addGoalBtn.disabled = true;
            const goalsRef = getPrivateRef('goals');
            const newGoalRef = push(goalsRef);

            try {
                await set(newGoalRef, {
                    title,
                    steps,
                    created_at: Date.now()
                });
                showMessage(`New mission "${title}" saved!`, false);
                goalTitleInput.value = '';
                milestoneInputs.forEach(input => input.value = '');
            } catch (e) {
                console.error("Error adding goal:", e);
                showMessage("Database error: Could not save mission.", true);
            } finally {
                addGoalBtn.disabled = false;
            }
        });

        function startGoalListener() {
            const goalsRef = getPrivateRef('goals');
            if (!goalsRef) return;

            onValue(goalsRef, (snapshot) => {
                const data = snapshot.val() || {};
                const goals = Object.keys(data).map(id => ({ id, ...data[id] }));

                goals.sort((a, b) => {
                    const aComplete = (a.steps || []).every(s => s.completed);
                    const bComplete = (b.steps || []).every(s => s.completed);
                    if (aComplete === bComplete) return 0;
                    return aComplete ? 1 : -1;
                });

                renderGoals(goals);
            }, (error) => {
                console.error("Goals Listener Error:", error);
                goalsLoadingEl.textContent = ':: MISSION DATA ERROR ::';
            });
        }

        function renderGoals(goals) {
            goalListContainerEl.innerHTML = '';

            if (goals.length === 0) {
                goalsLoadingEl.textContent = ':: NO ACTIVE MISSIONS. SET OBJECTIVES ABOVE ::';
                goalListContainerEl.appendChild(goalsLoadingEl);
                return;
            } else if (goalsLoadingEl.parentElement) {
                goalsLoadingEl.remove();
            }

            goals.forEach(goal => {
                const steps = goal.steps || [];
                const totalSteps = steps.length;
                const completedSteps = steps.filter(s => s.completed).length;
                const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

                let stepsHtml = '';
                steps.forEach((step, index) => {
                    const checked = step.completed ? 'checked' : '';
                    const lineThrough = step.completed ? 'line-through text-gray-500' : 'text-gray-300';
                    stepsHtml += `
                        <label class="flex items-center space-x-2 py-1 cursor-pointer">
                            <input type="checkbox"
                                   data-goal-id="${goal.id}"
                                   data-step-index="${index}"
                                   ${checked}
                                   class="form-checkbox h-4 w-4 text-green-400 rounded bg-gray-700/50"
                                   onchange="window.toggleStep(this)">
                            <span class="text-sm ${lineThrough}">${step.text}</span>
                        </label>
                    `;
                });

                const goalHtml = `
                    <div class="panel border-t-4 ${progress === 100 ? 'border-orange-500' : 'border-green-500'}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-lg font-extrabold accent-orange">${goal.title}</h4>
                            <span class="text-xs text-gray-400">${progress}% COMPLETE</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2.5 mb-4">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="space-y-1">
                            ${stepsHtml}
                        </div>
                        <button onclick="window.deleteGoal('${goal.id}')"
                                class="text-red-500 hover:text-red-300 text-xs mt-3 float-right">
                            ABORT MISSION
                        </button>
                    </div>
                `;
                goalListContainerEl.insertAdjacentHTML('beforeend', goalHtml);
            });
        }

        window.toggleStep = async function(checkbox) {
            if (!isAuthReady || !userId) return;

            const goalId = checkbox.dataset.goalId;
            const stepIndex = checkbox.dataset.stepIndex;
            const isCompleted = checkbox.checked;

            const stepRef = getPrivateRef(`goals/${goalId}/steps/${stepIndex}`);
            try {
                await update(stepRef, { completed: isCompleted });
                showMessage(isCompleted ? "Step marked COMPLETE!" : "Step reverted.", false);
            } catch (e) {
                console.error("Error toggling step:", e);
                showMessage("Database error: Could not update mission step.", true);
                checkbox.checked = !isCompleted;
            }
        };

        window.deleteGoal = async function(goalId) {
            if (!isAuthReady || !userId) return;

            const goalRef = getPrivateRef(`goals/${goalId}`);
            try {
                await remove(goalRef);
                showMessage("Mission aborted successfully.", false);
            } catch (e) {
                console.error("Error deleting goal:", e);
                showMessage("Database error: Could not abort mission.", true);
            }
        };

        postMessageBtn.addEventListener('click', async () => {
            if (!isAuthReady || !userId) return showMessage("Authentication required to transmit message.", true);

            const message = huddlePostInput.value.trim();
            if (message.length === 0) return showMessage("Message cannot be empty.", true);

            postMessageBtn.disabled = true;
            const musterRef = getPublicRef('community_messages');
            const newPostRef = push(musterRef);

            try {
                await set(newPostRef, {
                    message,
                    user_id: userId,
                    timestamp: Date.now()
                });
                huddlePostInput.value = '';
                showMessage("Message transmitted to The Muster.", false);
            } catch (e) {
                console.error("Error posting message:", e);
                showMessage("Database error: Could not transmit message.", true);
            } finally {
                postMessageBtn.disabled = false;
            }
        });

        function startMusterListener() {
            const musterRef = getPublicRef('community_messages');
            if (!musterRef) return;

            onValue(musterRef, (snapshot) => {
                const data = snapshot.val() || {};
                const posts = Object.keys(data).map(id => ({ id, ...data[id] }));
                posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                renderMusterFeed(posts);
            }, (error) => {
                console.error("Muster Listener Error:", error);
                musterLoadingEl.textContent = ':: CHANNEL STATUS: DATA LINK ERROR ::';
            });
        }

        function renderMusterFeed(posts) {
            communityFeedEl.innerHTML = '';

            if (posts.length === 0) {
                communityFeedEl.innerHTML = '<p class="text-center text-gray-500 py-4">:: FIRST TRANSMISSION AWAITED ::</p>';
                return;
            }

            posts.forEach(post => {
                const isMine = post.user_id === userId;
                const time = post.timestamp ? new Date(post.timestamp).toLocaleTimeString() : 'N/A';

                const postHtml = `
                    <div class="panel ${isMine ? 'bg-green-900/40 border-green-600' : 'bg-gray-700/50 border-gray-600'}">
                        <p class="text-xs font-bold ${isMine ? 'accent-green' : 'accent-orange'}">
                            ${isMine ? 'YOU' : (post.user_id || '').substring(0, 8) + '...'}
                            <span class="text-gray-500 font-normal">@ ${time}</span>
                        </p>
                        <p class="text-sm text-gray-300 mt-1 whitespace-pre-wrap">${post.message}</p>
                    </div>
                `;
                communityFeedEl.insertAdjacentHTML('beforeend', postHtml);
            });
        }

        const mockTranslations = {
            "68W": { title: "EMERGENCY MEDICAL TECHNICIAN / CLINICAL ASSISTANT", skills: ["Advanced Trauma Care", "Patient Triage", "Field Operations Management", "Basic Life Support (BLS)"] },
            "EO": { title: "HEAVY EQUIPMENT OPERATOR / SITE MANAGER", skills: ["Earth Moving Equipment Operation", "Site Preparation & Grading", "Safety Compliance (OSHA)", "Maintenance & Repair Scheduling"] },
            "PLATOON LEADER": { title: "PROJECT MANAGER / OPERATIONS DIRECTOR", skills: ["Strategic Planning (Agile/Waterfall)", "Team Leadership (20+ Personnel)", "Logistics & Supply Chain Management", "Budget Allocation & Oversight"] },
            "LOGISTICS": { title: "SUPPLY CHAIN ANALYST / INVENTORY CONTROL MANAGER", skills: ["Warehouse Operations", "Inventory Management Systems (WMS)", "Risk Mitigation", "Global Distribution Planning"] },
            "HR": { title: "HUMAN RESOURCES SPECIALIST / PERSONNEL ADMINISTRATOR", skills: ["Talent Acquisition", "Employee Relations", "Confidential Record Keeping", "Benefits Administration"] },
            "INFANTRY": { title: "SECURITY SPECIALIST / TEAM LEADER", skills: ["Risk Assessment", "Conflict Resolution", "Executive Protection", "Cross-Functional Team Collaboration"] },
        };

        document.getElementById('translate-btn').addEventListener('click', () => {
            const translateBtn      = document.getElementById('translate-btn');
            const militaryTermInput = document.getElementById('military-term-input');
            const translationResult = document.getElementById('translation-result');
            const jobTitleOutput    = document.getElementById('job-title-output');
            const skillsOutput      = document.getElementById('skills-output');

            const term = militaryTermInput.value.trim().toUpperCase();

            if (term.length < 2) {
                return showMessage("INPUT MOS OR DUTY CODE (MIN 2 CHARS).", true);
            }

            translateBtn.disabled = true;
            translationResult.classList.add('hidden');
            jobTitleOutput.textContent = '';
            skillsOutput.innerHTML = '';

            setTimeout(() => {
                const translation =
                    mockTranslations[term] ||
                    mockTranslations[Object.keys(mockTranslations).find(key => term.includes(key))];

                if (translation) {
                    jobTitleOutput.textContent = `CIVILIAN ROLE: ${translation.title}`;
                    let skillsList = '';
                    translation.skills.forEach(skill => {
                        skillsList += `<p class="text-sm font-semibold flex items-center accent-green">
                            <span class="accent-orange mr-2 text-xl">â€¢</span>${skill}</p>`;
                    });
                    skillsOutput.innerHTML =
                        `<h4 class="font-bold mt-2 accent-green">CORE SKILLS TRANSLATED:</h4><div class="space-y-1">${skillsList}</div>`;
                    translationResult.classList.remove('hidden');
                    showMessage(`Translation executed successfully for "${term}".`, false);
                } else {
                    jobTitleOutput.textContent = ":: DIRECT TRANSLATION FAILED ::";
                    skillsOutput.innerHTML =
                        "<p class='text-sm text-gray-500'>Try a common rating (e.g., HR, EO) or a general duty area (e.g., INFANTRY, LOGISTICS).</p>";
                    translationResult.classList.remove('hidden');
                    showMessage("TRANSLATION FAIL. RE-ENTER TERM.", true);
                }
                translateBtn.disabled = false;
            }, 500);
        });

        document.getElementById('view-history-btn').addEventListener('click', () => {
            document.getElementById('history-modal').classList.remove('hidden');
        });

        document.getElementById('close-history-btn').addEventListener('click', () => {
            document.getElementById('history-modal').classList.add('hidden');
        });

        window.switchTab = function(tabName) {
            const tabs = ['map', 'benefits', 'goals', 'muster', 'employment'];
            tabs.forEach(tab => {
                const content = document.getElementById(`content-${tab}`);
                const button  = document.getElementById(`tab-${tab}`);

                if (!content || !button) return;

                if (tab === tabName) {
                    content.classList.remove('hidden');
                    button.classList.add('tab-active');
                    button.classList.remove('tab-inactive');
                } else {
                    content.classList.add('hidden');
                    button.classList.remove('tab-active');
                    button.classList.add('tab-inactive');
                }
            });

            const section = document.getElementById(`content-${tabName}`);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            window.switchTab('employment');
        });

        document.getElementById('find-location-btn').addEventListener('click', () => {
            if (!isAuthReady) return showMessage("Authentication required to log location scan.", true);

            const button          = document.getElementById('find-location-btn');
            const loading         = document.getElementById('loading-indicator');
            const locationInfo    = document.getElementById('current-location');
            const resourceSection = document.getElementById('resource-section');
            const latLongDisplay  = document.getElementById('lat-long');

            button.disabled = true;
            button.textContent = 'EXECUTING SCAN...';
            loading.classList.remove('hidden');

            if (!navigator.geolocation) {
                showMessage("GEOLOCATION HARDWARE FAILURE.", true);
                button.disabled = false;
                button.textContent = 'EXECUTE LOCATION SCAN';
                loading.classList.add('hidden');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    button.textContent = 'SCAN COMPLETE';
                    loading.classList.add('hidden');

                    latLongDisplay.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    locationInfo.classList.remove('hidden');
                    resourceSection.classList.remove('hidden');

                    logSearch(lat, lon);

                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = 'RE-EXECUTE SCAN';
                    }, 1000);
                },
                (error) => {
                    let errorMessage = "ERROR: UNABLE TO RETRIEVE COORDS.";
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "ERROR: GEOLOCATION DENIED. ENABLE DEVICE SERVICES.";
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMessage = "ERROR: LOCATION DATA UNAVAILABLE.";
                    } else if (error.code === error.TIMEOUT) {
                        errorMessage = "ERROR: LOCATION REQUEST TIMEOUT.";
                    }

                    showMessage(errorMessage, true);

                    button.disabled = false;
                    button.textContent = 'EXECUTE LOCATION SCAN';
                    loading.classList.add('hidden');
                    locationInfo.classList.add('hidden');
                    resourceSection.classList.add('hidden');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        });

        // ðŸ”Ž SEARCH FUNCTION â€“ hooks into tabs + sections
        window.performSearch = function() {
            const input = document.getElementById('sov-search');
            if (!input) return;

            const q = input.value.toLowerCase().trim();
            if (!q) return;

            const sections = [
                { id: "content-map",       tab: "map" },
                { id: "content-benefits",  tab: "benefits" },
                { id: "content-goals",     tab: "goals" },
                { id: "content-muster",    tab: "muster" },
                { id: "content-employment",tab: "employment" }
            ];

            let found = false;

            sections.forEach(sec => {
                const el = document.getElementById(sec.id);
                if (!el) return;

                if (!found && el.innerText.toLowerCase().includes(q)) {
                    found = true;
                    window.switchTab(sec.tab);

                    el.scrollIntoView({ behavior: "smooth", block: "start" });
                    el.style.transition = "background 0.6s ease";
                    el.style.background = "rgba(56, 189, 248, 0.18)";

                    setTimeout(() => {
                        el.style.background = "";
                    }, 1400);
                }
            });

            if (!found) {
                showMessage("No results found for: " + q, true);
            }
        };
    </script>

</body>
</html>
