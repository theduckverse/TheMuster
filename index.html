<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Story Colorbooks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4DA3FF",       // kid-friendly blue
            primaryDark: "#1E88E5",
            accentYellow: "#FFD93D",
            accentPink: "#FF9EE2",
            bgLight: "#F0F8FF",
            card: "#FFFFFF"
          },
          borderRadius: {
            xl: "1rem",
            "2xl": "1.5rem",
          },
          boxShadow: {
            soft: "0 10px 25px rgba(15, 23, 42, 0.08)",
            heavy: "0 18px 40px rgba(15, 23, 42, 0.15)"
          },
          fontFamily: {
            fun: ["\"Comic Sans MS\"", "Poppins", "system-ui", "sans-serif"]
          }
        }
      }
    };
  </script>
</head>
<body class="min-h-screen bg-bgLight text-slate-800 font-fun">
<div class="min-h-screen">
  <!-- Top playful header -->
  <header class="border-b border-blue-100 bg-gradient-to-r from-[#FFFBEB] via-[#E0F2FE] to-[#FFF5F7] sticky top-0 z-10 shadow-soft">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-white border border-blue-100 flex items-center justify-center shadow-soft">
          <span class="text-2xl">üñçÔ∏è</span>
        </div>
        <div>
          <h1 class="text-xl font-bold tracking-tight text-slate-800">
            Magic Story Colorbooks
          </h1>
          <p class="text-xs text-slate-500">
            Turn your child‚Äôs ideas into custom story coloring books ‚ú®
          </p>
        </div>
      </div>
      <button
        class="hidden sm:inline-flex text-xs px-3 py-1.5 rounded-full border border-blue-200 text-slate-600 bg-white/80 hover:bg-white shadow-soft">
        Parent dashboard (coming soon)
      </button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 lg:py-10 flex flex-col lg:flex-row gap-8">
    <!-- LEFT: Form -->
    <section class="w-full lg:w-[40%]">
      <div class="bg-card rounded-2xl border border-blue-100 shadow-heavy p-5 relative overflow-hidden">
        <!-- cute background shapes -->
        <div class="pointer-events-none absolute -top-8 -right-10 w-32 h-32 rounded-full bg-[#FFEDD5]/80 blur-xl"></div>
        <div class="pointer-events-none absolute -bottom-10 -left-6 w-32 h-32 rounded-full bg-[#DBEAFE]/80 blur-xl"></div>

        <div class="relative">
          <h2 class="text-xl font-bold mb-1 flex items-center gap-2">
            ‚úèÔ∏è Describe your book
          </h2>
          <p class="text-sm text-slate-500 mb-5">
            Example: ‚ÄúAn iguana named Sammy who‚Äôs afraid of the dark and learns to be brave at night.‚Äù
          </p>

          <form id="book-form" class="space-y-4">
            <div>
              <label class="text-xs font-semibold text-slate-600 flex justify-between mb-1.5">
                <span>Book title</span>
                <span class="text-slate-400">Optional</span>
              </label>
              <input
                id="title"
                type="text"
                placeholder="Sammy the Brave Iguana"
                class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#F9FAFB] border border-blue-100 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30 placeholder:text-slate-400" />
            </div>

            <div>
              <label class="text-xs font-semibold text-slate-600 mb-1.5 block">
                ü¶é Main character
              </label>
              <input
                id="main-character"
                type="text"
                placeholder="An iguana named Sammy who's afraid of the dark"
                class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#F9FAFB] border border-blue-100 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30 placeholder:text-slate-400" />
            </div>

            <div>
              <label class="text-xs font-semibold text-slate-600 mb-1.5 block">
                üåü What should the story be about?
              </label>
              <textarea
                id="story-idea"
                rows="4"
                placeholder="Sammy hides under the covers at night until forest friends and glowing fireflies help him feel safe."
                class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#F9FAFB] border border-blue-100 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30 placeholder:text-slate-400 resize-none"></textarea>
              <p class="mt-1 text-[11px] text-slate-400">
                The app turns this into a cozy kids‚Äô story with matching coloring pages.
              </p>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-semibold text-slate-600 mb-1.5 block">
                  üéÇ Age range
                </label>
                <select id="age-range"
                        class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#F9FAFB] border border-blue-100 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30">
                  <option value="3-5">3‚Äì5 years</option>
                  <option value="5-7">5‚Äì7 years</option>
                  <option value="7-9">7‚Äì9 years</option>
                </select>
              </div>

              <div>
                <label class="text-xs font-semibold text-slate-600 mb-1.5 block">
                  üìñ Story length
                </label>
                <select id="page-count"
                        class="w-full text-sm px-3.5 py-2.5 rounded-2xl bg-[#F9FAFB] border border-blue-100 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/30">
                  <option value="8">8 pages</option>
                  <option value="12">12 pages</option>
                  <option value="16">16 pages</option>
                </select>
              </div>
            </div>

            <button
              id="generate-btn"
              type="submit"
              class="w-full mt-2 inline-flex items-center justify-center gap-2 text-sm font-semibold rounded-2xl px-5 py-3 bg-primary text-white shadow-soft hover:bg-primaryDark transition disabled:opacity-60 disabled:cursor-not-allowed">
              <span id="generate-btn-label">‚ú® Generate Book</span>
              <span id="generate-btn-spinner" class="hidden text-xs animate-pulse">Thinking‚Ä¶</span>
            </button>
          </form>

          <button
            id="download-pdf-btn"
            class="w-full mt-3 inline-flex items-center justify-center gap-2 text-xs font-semibold rounded-2xl px-4 py-2 bg-white border border-blue-100 text-slate-700 hover:bg-blue-50 transition disabled:opacity-60 disabled:cursor-not-allowed"
            disabled>
            üìÑ Download PDF
          </button>

          <button
            id="generate-images-btn"
            class="w-full mt-2 inline-flex items-center justify-center gap-2 text-xs font-semibold rounded-2xl px-4 py-2 bg-white border border-amber-100 text-slate-700 hover:bg-amber-50 transition disabled:opacity-60 disabled:cursor-not-allowed"
            disabled>
            üé® Generate Coloring Pages
          </button>

          <p class="mt-4 text-[11px] text-slate-400">
            Later you can add accounts, payments, and a saved bookshelf for each child.
          </p>
        </div>
      </div>
    </section>

    <!-- RIGHT: Output -->
    <section class="w-full lg:w-[60%]">
      <div class="bg-card rounded-2xl border border-blue-100 shadow-heavy p-5 flex flex-col h-full">
        <!-- Status -->
        <div id="status-bar"
             class="mb-4 rounded-2xl border border-blue-100 bg-[#EFF6FF] px-3.5 py-3 flex items-start gap-2 text-xs text-slate-700">
          <span id="status-icon" class="text-lg">üí°</span>
          <div>
            <p id="status-title" class="font-semibold">Ready to create a book.</p>
            <p id="status-text" class="text-slate-600 mt-0.5">
              Enter a character and story idea, then click ‚ÄúGenerate Book‚Äù.
            </p>
          </div>
        </div>

        <!-- Generated content -->
        <div id="output-container" class="flex-1 overflow-auto space-y-4 pr-1">
          <!-- Story -->
          <div id="story-card" class="hidden bg-white rounded-2xl border border-blue-100 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-400 mb-0.5 flex items-center gap-1">
                  <span>Story</span> <span>üìñ</span>
                </p>
                <h3 id="story-title" class="text-lg font-bold text-slate-800">Title</h3>
                <p id="story-tagline" class="text-xs text-slate-500 mt-1"></p>
              </div>
              <span class="text-[11px] rounded-full px-2.5 py-1 bg-blue-50 text-slate-700 border border-blue-100">
                AI generated
              </span>
            </div>
            <div id="story-body" class="space-y-3 text-sm leading-relaxed text-slate-700">
              <!-- paragraphs -->
            </div>
          </div>

          <!-- Coloring prompts -->
          <div id="prompts-card" class="hidden bg-white rounded-2xl border border-blue-100 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-400 mb-0.5 flex items-center gap-1">
                  <span>Coloring pages</span> <span>üñçÔ∏è</span>
                </p>
                <h3 class="text-lg font-bold text-slate-800">Page-by-page prompts</h3>
              </div>
              <span class="text-[11px] rounded-full px-2.5 py-1 bg-amber-50 text-slate-700 border border-amber-100">
                Line-art style
              </span>
            </div>
            <p class="text-xs text-slate-500 mb-2">
              Each prompt is written for a black-and-white, thick-outline coloring page.
            </p>
            <ol id="prompts-list" class="space-y-2 text-sm list-decimal list-inside text-slate-700">
              <!-- li items -->
            </ol>
          </div>

          <!-- Coloring images -->
          <div id="images-card" class="hidden bg-white rounded-2xl border border-blue-100 p-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <div>
                <p class="text-[11px] uppercase tracking-[0.12em] text-slate-400 mb-0.5 flex items-center gap-1">
                  <span>Coloring images</span> <span>üé®</span>
                </p>
                <h3 class="text-lg font-bold text-slate-800">AI-generated pages</h3>
              </div>
              <span class="text-[11px] rounded-full px-2.5 py-1 bg-pink-50 text-slate-700 border border-pink-100">
                Preview only
              </span>
            </div>
            <p class="text-xs text-slate-500 mb-2">
              These previews come from the page prompts. You can save them and use them in your print layout.
            </p>
            <div id="images-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- images go here -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const form = document.getElementById("book-form");
  const generateBtn = document.getElementById("generate-btn");
  const generateBtnLabel = document.getElementById("generate-btn-label");
  const generateBtnSpinner = document.getElementById("generate-btn-spinner");
  const downloadBtn = document.getElementById("download-pdf-btn");
  const imagesBtn = document.getElementById("generate-images-btn");

  const statusIcon = document.getElementById("status-icon");
  const statusTitle = document.getElementById("status-title");
  const statusText = document.getElementById("status-text");

  const storyCard = document.getElementById("story-card");
  const storyTitleEl = document.getElementById("story-title");
  const storyTaglineEl = document.getElementById("story-tagline");
  const storyBodyEl = document.getElementById("story-body");

  const promptsCard = document.getElementById("prompts-card");
  const promptsList = document.getElementById("prompts-list");

  const imagesCard = document.getElementById("images-card");
  const imagesGrid = document.getElementById("images-grid");

  let lastBookData = null;

  function setLoading(isLoading, labelWhenReady = "‚ú® Generate Book") {
    generateBtn.disabled = isLoading;
    generateBtnSpinner.classList.toggle("hidden", !isLoading);
    generateBtnLabel.textContent = isLoading ? "Generating..." : labelWhenReady;
  }

  function setStatus({ icon, title, text }) {
    statusIcon.textContent = icon;
    statusTitle.textContent = title;
    statusText.textContent = text;
  }

  function renderBook(data) {
    const { title, tagline, paragraphs, prompts, ageRange } = data;

    storyTitleEl.textContent = title || "Your Custom Story";
    storyTaglineEl.textContent = tagline || (ageRange ? `For ages ${ageRange}` : "");
    storyBodyEl.innerHTML = "";
    (paragraphs || []).forEach(p => {
      const para = document.createElement("p");
      para.className = "text-slate-700";
      para.textContent = p;
      storyBodyEl.appendChild(para);
    });
    storyCard.classList.remove("hidden");

    promptsList.innerHTML = "";
    (prompts || []).forEach(item => {
      const li = document.createElement("li");
      li.className = "text-slate-700";
      li.innerHTML = `<span class="font-semibold">Page ${item.page}:</span> ${item.prompt}`;
      promptsList.appendChild(li);
    });
    if (prompts && prompts.length) {
      promptsCard.classList.remove("hidden");
    }

    setStatus({
      icon: "‚úÖ",
      title: "Book generated.",
      text: "Review the story and coloring prompts below. You can also download a simple PDF."
    });

    lastBookData = data;
    downloadBtn.disabled = false;
    imagesBtn.disabled = !(prompts && prompts.length);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const title = document.getElementById("title").value;
    const mainCharacter = document.getElementById("main-character").value;
    const storyIdea = document.getElementById("story-idea").value;
    const ageRange = document.getElementById("age-range").value;
    const pageCount = document.getElementById("page-count").value;

    if (!mainCharacter.trim() && !storyIdea.trim()) {
      setStatus({
        icon: "‚ö†Ô∏è",
        title: "Tell the AI something to work with.",
        text: "Add a main character, a fear, or a situation you want the story to be about."
      });
      return;
    }

    setLoading(true);
    downloadBtn.disabled = true;
    imagesBtn.disabled = true;
    lastBookData = null;

    setStatus({
      icon: "‚ú®",
      title: "Generating your custom story coloring book‚Ä¶",
      text: "Talking to the AI to create a full story and page-by-page coloring prompts."
    });

    try {
      const res = await fetch("/api/generate-book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, mainCharacter, storyIdea, ageRange, pageCount })
      });

      if (!res.ok) {
        throw new Error("Request failed");
      }

      const data = await res.json();
      renderBook(data);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Something went wrong.",
        text: "Check your server logs or API key configuration, then try again."
      });
    } finally {
      setLoading(false);
    }
  });

  function renderImages(images) {
    imagesGrid.innerHTML = "";
    images.forEach((img) => {
      const wrapper = document.createElement("figure");
      wrapper.className = "border border-blue-100 rounded-2xl overflow-hidden bg-[#F9FAFB]";

      const imageEl = document.createElement("img");
      imageEl.src = img.url;
      imageEl.alt = `Coloring page ${img.page}`;
      imageEl.className = "w-full h-auto block";

      const caption = document.createElement("figcaption");
      caption.className = "text-xs text-slate-500 px-3 py-2";
      caption.textContent = `Page ${img.page}`;

      wrapper.appendChild(imageEl);
      wrapper.appendChild(caption);
      imagesGrid.appendChild(wrapper);
    });

    imagesCard.classList.remove("hidden");

    setStatus({
      icon: "üñçÔ∏è",
      title: "Coloring pages generated.",
      text: "These previews are based on your prompts. You can save them and use them in your print-ready layout."
    });
  }

  downloadBtn.addEventListener("click", async () => {
    if (!lastBookData) return;

    try {
      const res = await fetch("/api/export-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastBookData)
      });

      if (!res.ok) throw new Error("PDF request failed");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = (lastBookData.title || "custom-story") + ".pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "PDF download failed.",
        text: "Check the server console for errors in /api/export-pdf."
      });
    }
  });

  imagesBtn.addEventListener("click", async () => {
    if (!lastBookData || !lastBookData.prompts || !lastBookData.prompts.length) return;

    imagesBtn.disabled = true;
    setStatus({
      icon: "‚ú®",
      title: "Generating coloring page images‚Ä¶",
      text: "Using your prompts to create coloring page previews."
    });

    try {
      const res = await fetch("/api/generate-images", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompts: lastBookData.prompts })
      });

      if (!res.ok) throw new Error("Image request failed");

      const data = await res.json();
      renderImages(data.images || []);
    } catch (err) {
      console.error(err);
      setStatus({
        icon: "‚ùå",
        title: "Image generation failed.",
        text: "Check the server logs for /api/generate-images."
      });
    } finally {
      imagesBtn.disabled = false;
    }
  });
</script>
</body>
</html>
